define(["common/global","lib/jquery/jquery.validate"],function(A){var B=function(E){var E=E||{},L=!!E.isAUIButton,I=E.isIndexPage,P=!!E.isOneStepLogin,Q=$("#J_registerForm"),D=$("#J_agreeContract"),O=$("#J_submitReg"),G=$("#J_cancelReg");document.getElementById("J_registerForm").reset();var N=isAbleskyDomain?HTTP_SERVER:"";$.extend($.validator.methods,{email:function(S,R){return this.optional(R)||/^([\w]+)(.[\w]+)*@([\w-]+\.){1,5}([A-Za-z]){2,4}$/.test(S)}});$.validator.addMethod("notAllNum",function(T,S){var R=/[^\d]/ig;return R.test(T)||this.optional(S)},"用户名不能全为数字");$.validator.addMethod("notBeginWith",function(T,S){var R=/^(?!_)^(?!-)/;return R.test(T)||this.optional(S)},"用户名不能以‘-’或‘_’开头");$.validator.addMethod("checkLetter",function(T,S){var R=/^[_0-9a-zA-Z\-]+$/;return R.test(T)||this.optional(S)},"用户名不能包含汉字");$.validator.addMethod("checkAbleSky",function(T,S){var R=/ablesky/i;return !(R.test(T)||this.optional(S))},"用户名不能包含AbleSky");var F=function(R){if(R){$("#J_changeVerfiycode").show()}else{$("#J_changeVerfiycode").hide()}};var J=Q.validate({success:function(R){R.parent().siblings(".field-wrapper").removeClass("field-waiting-center field-invalid").addClass("field-valid");if(I||P){R.parent().hide()}if(E.registerSuccess){E.registerSuccess()}R.remove();F(false)},errorPlacement:function(R,S){if(I||P){S.parents(".field-wrapper").removeClass("field-valid").addClass("field-invalid");R.appendTo(S.parents(".field-wrapper").siblings(".invalid-text"));S.parents(".field-wrapper").siblings(".invalid-text").show()}else{S.parent().removeClass("field-valid").addClass("field-invalid");R.appendTo(S.parent().siblings(".invalid-text"))}if(E.registerError){E.registerError()}if($(S).attr("id")=="J_verifycode"){F(false)}},rules:{username:{required:true,notAllNum:true,notBeginWith:true,checkLetter:true,checkAbleSky:true,minlength:3,maxlength:20,remote:{url:N+"newAccountChecker.do?action=checkIfUserNameDuplicated",beforeSend:function(){$("#J_enterUsername").parents(".field-wrapper").addClass("field-waiting")},dataType:"jsonp",complete:function(){$("#J_enterUsername").parents(".field-wrapper").removeClass("field-waiting")}}},email:{required:true,email:true,maxlength:60,remote:{url:N+"newAccountChecker.do?action=checkIfEmailDuplicated",beforeSend:function(){$("#J_enterEmail").parents(".field-wrapper").addClass("field-waiting")},dataType:"jsonp",complete:function(){$("#J_enterEmail").parents(".field-wrapper").removeClass("field-waiting")}}},password:{required:true,minlength:4,maxlength:20},password2:{required:true,minlength:4,equalTo:"#J_enterPassword"},verifycode:{required:true,maxlength:4,minlength:4,remote:{url:N+"newAccountChecker.do?action=checkVerifyCode",beforeSend:function(S,R){$("#J_verifycode").parents(".field-wrapper").addClass("field-waiting-verifycode")},dataType:"jsonp",complete:function(){$("#J_verifycode").parents(".field-wrapper").removeClass("field-waiting-verifycode")}}}},messages:{username:{required:"用户名不能为空",minlength:"用户名至少3位字符",maxlength:"用户名最多20位字符",remote:"用户名已存在，请重新输入"},email:{required:"邮箱不能为空",email:"邮箱格式错误，请您再检查下",maxlength:"邮箱最多60位字符",remote:"邮箱已注册"},password:{required:"密码不能为空",minlength:"密码至少4位字符",maxlength:"密码最多20位字符"},password2:{required:"确认密码不能为空",minlength:"密码至少4位字符",equalTo:"密码不同"},verifycode:{required:"验证码不能为空",maxlength:"验证码为4位",minlength:"验证码为4位",remote:"验证码错误"}}});var M=$("#J_registerMod .field");M.bind({keydown:function(S){var R=this.value,U=S.keyCode,T=$(this).next("label.empty-text");if(U>47){T.hide()}},keyup:function(){var S=this.id,R=this.value,T=$(this).next("label.empty-text");if(!R){T.show()}else{T.hide()}if(S=="J_enterUsername"||S=="J_enterEmail"){J.element("#"+S)}},focus:function(){var R=$(this).next("label.empty-text");R.addClass("emptytext-focus")},blur:function(){var R=$(this).next("label.empty-text");R.removeClass("emptytext-focus")}});$("#J_enterUsername").bind({keyup:function(S){var T=$(this),R=T.val();T.val(R.replace(/[^A-Za-z0-9_\-\u4e00-\u9fa5]/g,""))}});var H=function(){var R=N+"accountRedirect.do?action=getVerifyCode&_r="+$.now();hasVerifycode=true;$("#J_verifycodeImg").attr("src",R)};$("#J_verifycode").bind({focus:function(R){$(this).val("");H();F(true)},blur:function(){F(false)},keyup:function(){var R=$(this)}});$("#J_changeVerfiycode").click(function(R){R.preventDefault();H();$("#J_verifycode").focus()});D.click(function(R){D=$("#J_agreeContract");if(!D[0].checked){K()}else{C()}});O.hover(function(){if(!$(this).hasClass("disable-register")){$(this).addClass("hover")}},function(){if($(this).hasClass("hover")){$(this).removeClass("hover")}});var C=function(){O.removeClass("disable-register graybtn35_color");$("span",O).removeClass("graybtn35_text")};var K=function(){O.addClass("disable-register");if(L){O.addClass("graybtn35_color");$("span",O).addClass("graybtn35_text")}};O.click(function(S){S.preventDefault();var R=D[0].checked;var T=$(this).attr("isReging");if(R&&Q.valid()){if(T=="true"){return }O.attr("isReging","true");K();if(L){$("span",O).addClass("graybtn35_text").html("正在提交")}else{O.html("正在提交")}require(["common/md5"],function(W){var V=$("#J_enterEmail").val(),U=N+"register.do?ref="+window.location.hostname;$.ajax({url:U,dataType:"jsonp",data:{username:$("#J_enterUsername").val(),email:V,password:hex_md5($("#J_enterPassword").val()),password2:hex_md5($("#J_confirmPassword").val()),verifycode:$("#J_verifycode").val()},success:function(Z){var X=Z.activated;var a=Z.username;var Y=Z.email;if(E.callback){E.callback()}else{window.location.href=SEARCH_SERVER+"course.do?aft=recommend&from=reg"}},error:function(){if(L){$("span",O).html("立即注册")}else{O.html("立即注册")}C();O.attr("isReging","false")}})})}});G.click(function(){$("#J_toggleRegister").click()})};return{init:B}}); 